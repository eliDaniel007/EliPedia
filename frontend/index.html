<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELIPEDIA - List Master üéÆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        /* Navigation */
        .nav {
            background: rgba(0,0,0,0.2);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .logo { font-size: 2em; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        .nav-btn:hover, .nav-btn.active { background: white; color: #667eea; }

        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        /* Welcome */
        .welcome { text-align: center; color: white; margin-bottom: 30px; }
        .welcome h1 { font-size: 3.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .welcome p { font-size: 1.3em; opacity: 0.9; }

        /* Modes */
        .mode { display: none; }
        .mode.active { display: block; }

        /* Search & Grid */
        .search-section { background: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .search-bar { display: flex; gap: 10px; }
        .search-bar input { flex: 1; padding: 15px 20px; border: 2px solid #667eea; border-radius: 10px; font-size: 1.1em; }
        .search-bar button { background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; cursor: pointer; }
        
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }

        /* Cards */
        .item-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .item-card:hover { transform: scale(1.05); }
        .badge { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; }

        /* Game UI */
        .game-setup, .game-area, .auction-area {
            background: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .game-stats { display: flex; gap: 30px; }
        .stat-box { text-align: center; padding: 15px 25px; background: #f8f9fa; border-radius: 10px; min-width: 100px; }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9em; }

        .game-input { width: 100%; padding: 20px; border: 3px solid #667eea; border-radius: 10px; font-size: 1.5em; text-align: center; }
        .found-words { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 30px; }
        .found-word { background: #48bb78; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }

        /* Duel UI */
        .mode-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .mode-card { border: 2px solid #e2e8f0; border-radius: 15px; padding: 25px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .mode-card:hover, .mode-card.selected { border-color: #667eea; background: #f7fafc; transform: translateY(-5px); }
        .mode-card.selected { background: #ebf4ff; border-width: 3px; }
        .mode-card h3 { color: #2d3748; margin-bottom: 10px; font-size: 1.5em; }
        .mode-card p { color: #718096; }

        .difficulty-selector { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .diff-btn { padding: 10px 20px; border: 2px solid #cbd5e0; border-radius: 20px; cursor: pointer; background: white; font-weight: bold; }
        .diff-btn.active { background: #667eea; color: white; border-color: #667eea; }

        .auction-controls { text-align: center; margin-top: 30px; }
        .auction-btn { padding: 15px 30px; font-size: 1.2em; border-radius: 10px; border: none; cursor: pointer; margin: 0 10px; transition: transform 0.2s; }
        .btn-raise { background: #48bb78; color: white; }
        .btn-fold { background: #f56565; color: white; }
        .auction-btn:hover { transform: scale(1.05); }

        .auction-status { text-align: center; font-size: 1.5em; margin: 20px 0; color: #2d3748; font-weight: bold; }
        .timer-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 20px; }
        .timer-fill { height: 100%; background: #f56565; width: 100%; transition: width 1s linear; }

        /* Loading & Error */
        .loading { text-align: center; color: white; font-size: 1.5em; padding: 50px; }
        .error { background: #ff6b6b; color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .list-details { background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .game-log { max-height: 150px; overflow-y: auto; background: #f7fafc; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #e2e8f0; font-family: monospace; }
        .log-entry { margin-bottom: 5px; }
        .log-entry.ai { color: #e53e3e; }
        .log-entry.player { color: #3182ce; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="logo">üéÆ ELIPEDIA</div>
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showMode('learn')">üìö Apprendre</button>
            <button class="nav-btn" onclick="showMode('play')">üéÆ Jouer</button>
        </div>
    </nav>

    <div class="container">
        <div class="welcome">
            <h1>List Master üéÆ</h1>
            <p>Votre Encyclop√©die Interactive de Listes</p>
        </div>

        <!-- MODE APPRENDRE -->
        <div id="learn-mode" class="mode active">
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Rechercher un pays d'Afrique..." onkeypress="handleSearchKeyPress(event)">
                    <button onclick="performSearch()">üîç Rechercher</button>
                </div>
            </div>
            <div id="loading" class="loading" style="display: none;">Chargement...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="categories" class="categories-grid"></div>
            <div id="list-details" class="list-details" style="display: none;"></div>
        </div>

        <!-- MODE JEU -->
        <div id="play-mode" class="mode">
            
            <!-- √âcran de configuration -->
            <div class="game-setup" id="game-setup">
                <h2>Choisissez votre d√©fi</h2>
                
                <div class="mode-selection">
                    <div class="mode-card" onclick="selectGameMode('solo')" id="card-solo">
                        <h3>üßò Solo Classique</h3>
                        <p>Prenez votre temps pour trouver les 54 pays.</p>
                    </div>
                    <div class="mode-card" onclick="selectGameMode('duel_ai')" id="card-duel-ai">
                        <h3>ü§ñ Duel vs IA</h3>
                        <p>Ench√©rissez contre l'ordi. Le plus audacieux joue !</p>
                    </div>
                    <div class="mode-card" onclick="selectGameMode('duel_friend')" id="card-duel-friend">
                        <h3>üë• Duel vs Ami</h3>
                        <p>Jouez √† deux sur le m√™me √©cran.</p>
                    </div>
                </div>

                <div id="ai-difficulty" style="display: none; text-align: center;">
                    <h3>Niveau de l'IA</h3>
                    <div class="difficulty-selector">
                        <div class="diff-btn active" onclick="setDifficulty('easy')">üë∂ Facile (Prudent)</div>
                        <div class="diff-btn" onclick="setDifficulty('medium')">üòé Moyen (Joueur)</div>
                        <div class="diff-btn" onclick="setDifficulty('hard')">üòà Difficile (Expert)</div>
                    </div>
                </div>

                <div id="friends-setup" style="display: none; text-align: center;">
                    <h3>Nombre de joueurs</h3>
                    <div class="difficulty-selector">
                        <div class="diff-btn active" onclick="setPlayerCount(2)">2 Joueurs</div>
                        <div class="diff-btn" onclick="setPlayerCount(3)">3 Joueurs</div>
                        <div class="diff-btn" onclick="setPlayerCount(4)">4 Joueurs</div>
                    </div>
                </div>

                <button class="start-game-btn" onclick="initGameSession()" style="margin-top: 30px; font-size: 1.8em; padding: 25px; box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); text-transform: uppercase; letter-spacing: 2px;">
                    üöÄ Commencer la partie
                </button>
            </div>

            <!-- √âcran d'ench√®res -->
            <div class="auction-area" id="auction-area" style="display: none;">
                <h2>üì¢ Phase d'Ench√®res</h2>
                <div class="auction-status" id="auction-status">
                    Combien de pays pouvez-vous citer en 60 secondes ?
                </div>
                
                <div class="game-log" id="auction-log"></div>

                <div class="stat-box" style="margin: 20px auto; max-width: 200px;">
                    <div class="stat-label">Ench√®re actuelle</div>
                    <div class="stat-value" id="current-bid">0</div>
                </div>

                <div class="auction-controls" id="auction-controls">
                    <button class="auction-btn btn-raise" onclick="placeBid(1)">+1</button>
                    <button class="auction-btn btn-raise" onclick="placeBid(2)">+2</button>
                    <button class="auction-btn btn-raise" onclick="placeBid(5)">+5</button>
                    <button class="auction-btn btn-fold" onclick="fold()">Se coucher</button>
                </div>
            </div>

            <!-- √âcran de jeu -->
            <div class="game-area" id="game-area" style="display: none;">
                <div class="game-header">
                    <div>
                        <h2 id="game-player-name">Joueur</h2>
                        <p id="game-objective">Objectif : <span id="target-score">0</span> pays</p>
                    </div>
                    <div class="game-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="timer">60</div>
                            <div class="stat-label">Secondes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">Trouv√©s</div>
                        </div>
                    </div>
                </div>

                <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>

                <div class="game-input-area">
                    <input type="text" class="game-input" id="game-input" placeholder="Tapez un pays..." autocomplete="off">
                </div>

                <div class="found-words" id="found-words"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        
        // --- ETAT GLOBAL ---
        let appState = {
            mode: 'learn', // 'learn' | 'play'
            categories: [],
            listData: null,
            items: [], // Liste normalis√©e des pays
            game: {
                type: null, // 'solo' | 'duel_ai' | 'duel_friend'
                difficulty: 'easy',
                playerCount: 2,
                players: [], // ['p1', 'p2', ...]
                currentBid: 0,
                bidHolder: null, 
                turnIndex: 0, // Index dans players
                target: 0,
                found: new Set(),
                timeLeft: 60,
                interval: null,
                isPlaying: false
            }
        };

        // --- ALIAS & NORMALISATION ---
        const ALIASES = {
            'rdc': 'r√©publique d√©mocratique du congo',
            'congo rdc': 'r√©publique d√©mocratique du congo',
            'congo kinshasa': 'r√©publique d√©mocratique du congo',
            'kinshasa': 'r√©publique d√©mocratique du congo',
            'za√Øre': 'r√©publique d√©mocratique du congo',
            'zaire': 'r√©publique d√©mocratique du congo',
            
            'rca': 'r√©publique centrafricaine',
            'centrafrique': 'r√©publique centrafricaine',
            'centrafrica': 'r√©publique centrafricaine',
            
            'sao tome': 's√£o tom√©-et-principe',
            'sao tom√©': 's√£o tom√©-et-principe',
            'sao tome et principe': 's√£o tom√©-et-principe',
            
            'swaziland': 'eswatini',
            
            'cote d ivoire': 'c√¥te d\'ivoire',
            'cote divoire': 'c√¥te d\'ivoire',
            'ci': 'c√¥te d\'ivoire',
            
            'cap vert': 'cap-vert',
            'cabo verde': 'cap-vert',
            
            'afrique du sud': 'afrique du sud',
            'rsa': 'afrique du sud',
            'ads': 'afrique du sud',

            'congo': 'r√©publique du congo',
            'congo brazzaville': 'r√©publique du congo',
            'congo brazza': 'r√©publique du congo',
            'brazzaville': 'r√©publique du congo',

            'guinee bissau': 'guin√©e-bissau',
            'guinee equatoriale': 'guin√©e √©quatoriale'
        };

        function normalize(str) {
            return str.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Enl√®ve accents
                .replace(/[^a-z0-9]/g, ""); // Enl√®ve espaces et tirets
        }

        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function checkAnswer(input, target) {
            const normInput = normalize(input);
            const normTarget = normalize(target);
            
            // 1. Exact match apr√®s normalisation
            if (normInput === normTarget) return true;

            // 2. Levenshtein (Tol√©rance)
            const len = normTarget.length;
            const dist = levenshtein(normInput, normTarget);
            
            if (len <= 4 && dist === 0) return true;
            if (len > 4 && len <= 8 && dist <= 1) return true;
            if (len > 8 && dist <= 2) return true;

            return false;
        }

        // --- INITIALISATION ---
        async function init() {
            // Afficher le chargement
            document.getElementById('loading').style.display = 'block';
            await loadData();
            initSearch();
            setupGameUI(); // Initialiser les √©couteurs d'√©v√©nements si n√©cessaire
            document.getElementById('loading').style.display = 'none';
        }

        function setupGameUI() {
            // Rien de sp√©cial pour l'instant, mais pr√™t pour plus tard
        }

        async function loadData() {
            try {
                // Charger la liste des pays (ID 1 par d√©faut ou via API)
                const res = await fetch(`${API_BASE}/lists`);
                const data = await res.json();
                
                // Si on a des listes
                if (data.data && data.data.length > 0) {
                    const listId = data.data[0].id;
                    const detailRes = await fetch(`${API_BASE}/lists/${listId}`);
                    const detailData = await detailRes.json();
                    
                    appState.listData = detailData.data;
                    appState.items = appState.listData.items.map(i => i.name);
                    
                    // Affichage initial (Apprendre) - Forcer l'affichage
                    viewListDetails(appState.listData);
                } else {
                    document.getElementById('error').textContent = "Aucune liste trouv√©e (V√©rifiez le seed).";
                    document.getElementById('error').style.display = 'block';
                }
            } catch (e) {
                console.error("Erreur chargement", e);
                document.getElementById('error').textContent = "Erreur de connexion au serveur.";
                document.getElementById('error').style.display = 'block';
            }
        }

        // --- UI GESTION ---
        function showMode(mode) {
            appState.mode = mode;
            document.querySelectorAll('.mode').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            if (mode === 'learn') {
                document.getElementById('learn-mode').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else {
                document.getElementById('play-mode').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                resetGameSetup();
            }
        }

        // --- LOGIQUE JEU ---
        let selectedGameMode = 'solo';

        function selectGameMode(mode) {
            selectedGameMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            
            if (mode === 'solo') document.getElementById('card-solo').classList.add('selected');
            if (mode === 'duel_ai') document.getElementById('card-duel-ai').classList.add('selected');
            if (mode === 'duel_friend') document.getElementById('card-duel-friend').classList.add('selected');

            document.getElementById('ai-difficulty').style.display = mode === 'duel_ai' ? 'block' : 'none';
            document.getElementById('friends-setup').style.display = mode === 'duel_friend' ? 'block' : 'none';
        }

        function setDifficulty(diff) {
            appState.game.difficulty = diff;
            document.querySelectorAll('#ai-difficulty .diff-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPlayerCount(count) {
            appState.game.playerCount = count;
            document.querySelectorAll('#friends-setup .diff-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function initGameSession() {
            appState.game.type = selectedGameMode;
            appState.game.found = new Set();
            appState.game.timeLeft = 60;
            appState.game.isPlaying = false;
            
            // Configuration des joueurs
            if (selectedGameMode === 'duel_friend') {
                appState.game.players = Array.from({length: appState.game.playerCount}, (_, i) => `p${i+1}`);
            } else if (selectedGameMode === 'duel_ai') {
                appState.game.players = ['p1', 'ai'];
            } else {
                appState.game.players = ['p1'];
            }

            document.getElementById('game-setup').style.display = 'none';

            if (selectedGameMode === 'solo') {
                startSoloGame();
            } else {
                startAuctionPhase();
            }
        }

        // --- MODE SOLO ---
        function startSoloGame() {
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('game-player-name').textContent = "Mode Solo";
            document.getElementById('game-objective').innerHTML = "Trouvez les 54 pays ! (Pas de limite de temps)";
            document.getElementById('timer').parentElement.style.display = 'none'; // Pas de timer en solo classique
            document.getElementById('target-score').textContent = "54";
            
            setupInputListener();
        }

        // --- MODE ENCH√àRES (DUEL) ---
        function startAuctionPhase() {
            document.getElementById('auction-area').style.display = 'block';
            appState.game.currentBid = 0;
            appState.game.bidHolder = null;
            appState.game.turnIndex = 0; // Le premier joueur commence
            
            updateAuctionUI();
            logAuction("Le duel commence ! Qui dit mieux ?");
        }

        function updateAuctionUI() {
            document.getElementById('current-bid').textContent = appState.game.currentBid;
            
            const currentPlayer = appState.game.players[appState.game.turnIndex];
            
            // Si c'est au tour de l'IA
            if (currentPlayer === 'ai') {
                document.getElementById('auction-controls').style.display = 'none';
                document.getElementById('auction-status').textContent = "L'IA r√©fl√©chit...";
                setTimeout(aiBidTurn, 1500);
            } else {
                document.getElementById('auction-controls').style.display = 'block';
                const label = getPlayerLabel(currentPlayer);
                document.getElementById('auction-status').innerHTML = 
                    `C'est √† <span style="color:#667eea">${label}</span> d'ench√©rir !`;
            }
        }

        function placeBid(amount) {
            const newBid = appState.game.currentBid + amount;
            if (newBid > 54) {
                alert("Il n'y a que 54 pays !");
                return;
            }
            
            appState.game.currentBid = newBid;
            const currentPlayer = appState.game.players[appState.game.turnIndex];
            appState.game.bidHolder = currentPlayer;
            
            const playerLabel = getPlayerLabel(currentPlayer);
            logAuction(`${playerLabel} monte √† ${newBid} pays !`, 'player');

            // Passer la main
            switchTurn();
        }

        function fold() {
            const currentPlayer = appState.game.players[appState.game.turnIndex];
            const playerLabel = getPlayerLabel(currentPlayer);
            logAuction(`${playerLabel} se couche !`, 'player');
            
            if (appState.game.bidHolder === null) {
                // Personne n'a encore ench√©ri
                alert("Il faut au moins une ench√®re !");
                return;
            }

            // Si on se couche, c'est celui qui tient l'ench√®re qui doit jouer
            endAuction();
        }

        function switchTurn() {
            appState.game.turnIndex = (appState.game.turnIndex + 1) % appState.game.players.length;
            updateAuctionUI();
        }

        function getPlayerLabel(code) {
            if (code === 'ai') return 'L\'Ordinateur';
            if (code.startsWith('p')) return `Joueur ${code.substring(1)}`;
            return code;
        }

        function logAuction(msg, type = '') {
            const log = document.getElementById('auction-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = msg;
            log.prepend(entry);
        }

        // --- INTELLIGENCE ARTIFICIELLE ---
        function aiBidTurn() {
            const current = appState.game.currentBid;
            const difficulty = appState.game.difficulty;
            let limit = 0;

            // Limites de l'IA selon difficult√©
            if (difficulty === 'easy') limit = 6;      // Prudent
            if (difficulty === 'medium') limit = 12;   // Joueur
            if (difficulty === 'hard') limit = 20;     // Expert

            // Facteur al√©atoire (bluff)
            const randomFactor = Math.floor(Math.random() * 3); 
            const aiLimit = limit + randomFactor;

            if (current < aiLimit) {
                // L'IA monte
                let raise = 1;
                if (aiLimit - current > 5) raise = 2;
                
                appState.game.currentBid += raise;
                appState.game.bidHolder = 'ai';
                logAuction(`L'IA monte √† ${appState.game.currentBid} pays !`, 'ai');
                
                // Passer la main
                switchTurn();
            } else {
                // L'IA se couche
                logAuction("L'IA se couche. √Ä toi de jouer !", 'ai');
                
                // C'est fini pour l'IA, le joueur (bidHolder) doit jouer
                if (appState.game.bidHolder === 'ai') {
                   // Si l'IA tenait l'ench√®re et se couche contre elle-m√™me (impossible logiquement mais bon)
                   endAuction();
                } else {
                   // Le joueur a gagn√© l'ench√®re
                   endAuction();
                }
            }
        }

        function endAuction() {
            document.getElementById('auction-area').style.display = 'none';
            startTimedGame(appState.game.bidHolder, appState.game.currentBid);
        }

        // --- JEU CHRONOM√âTR√â ---
        function startTimedGame(player, target) {
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('timer').parentElement.style.display = 'block';
            
            const playerLabel = getPlayerLabel(player);
            document.getElementById('game-player-name').textContent = `${playerLabel} joue !`;
            document.getElementById('game-objective').innerHTML = `Objectif : <span style="color:#e53e3e;font-weight:bold">${target}</span> pays en 60s`;
            
            appState.game.target = target;
            appState.game.timeLeft = 60;
            appState.game.isPlaying = true;
            
            setupInputListener();
            startTimer();
        }

        function startTimer() {
            updateTimerDisplay();
            appState.game.interval = setInterval(() => {
                appState.game.timeLeft--;
                updateTimerDisplay();

                if (appState.game.timeLeft <= 0) {
                    gameOver(false);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const time = appState.game.timeLeft;
            document.getElementById('timer').textContent = time;
            const pct = (time / 60) * 100;
            document.getElementById('timer-fill').style.width = `${pct}%`;
        }

        function setupInputListener() {
            const input = document.getElementById('game-input');
            input.value = '';
            input.focus();
            
            // Nettoyer les anciens listeners
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            newInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleGameSubmit(newInput);
            });
            
            // Focus constant
            document.addEventListener('click', () => {
                if(appState.game.isPlaying) newInput.focus();
            });
        }

        function handleGameSubmit(input) {
            const val = input.value.trim();
            if (!val) return;

            // V√©rification Alias
            let checkVal = val.toLowerCase();
            if (ALIASES[checkVal]) checkVal = ALIASES[checkVal];

            // V√©rification
            let found = null;
            for (const item of appState.items) {
                if (checkAnswer(checkVal, item)) {
                    found = item;
                    break;
                }
            }

            if (found) {
                // D√©j√† trouv√© ?
                if ([...appState.game.found].some(f => f.toLowerCase() === found.toLowerCase())) {
                    // Animation "D√©j√† vu"
                    input.style.borderColor = "orange";
                    setTimeout(() => input.style.borderColor = "#667eea", 300);
                } else {
                    // SUCC√àS
                    appState.game.found.add(found);
                    addFoundWord(found);
                    input.value = '';
                    document.getElementById('score').textContent = appState.game.found.size;

                    // Victoire ?
                    if (appState.game.type !== 'solo' && appState.game.found.size >= appState.game.target) {
                        gameOver(true);
                    } else if (appState.game.found.size === 54) {
                         gameOver(true);
                    }
                }
            } else {
                // Erreur
                input.style.borderColor = "red";
                setTimeout(() => input.style.borderColor = "#667eea", 300);
            }
        }

        function addFoundWord(word) {
            const div = document.createElement('div');
            div.className = 'found-word';
            div.textContent = word;
            document.getElementById('found-words').appendChild(div);
        }

        function gameOver(success) {
            clearInterval(appState.game.interval);
            appState.game.isPlaying = false;
            
            let msg = "";
            if (appState.game.type === 'solo') {
                msg = "Bravo ! Vous avez termin√© la liste !";
            } else {
                if (success) {
                    msg = `üéâ VICTOIRE ! Contrat rempli (${appState.game.target} pays).`;
                } else {
                    msg = `üíÄ PERDU ! Temps √©coul√©. Vous en avez trouv√© ${appState.game.found.size} sur ${appState.game.target}.`;
                }
            }

            alert(msg);
            showMode('play'); // Retour menu
        }

        function resetGameSetup() {
            document.getElementById('game-setup').style.display = 'block';
            document.getElementById('auction-area').style.display = 'none';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('found-words').innerHTML = '';
            document.getElementById('score').textContent = '0';
            document.getElementById('auction-log').innerHTML = '';
            appState.game.found = new Set();
        }

        // --- AFFICHAGE APPRENDRE ---
        function viewListDetails(list) {
            const listDetails = document.getElementById('list-details');
            listDetails.style.display = 'block';
            document.getElementById('categories').style.display = 'none';
            
            listDetails.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <span class="badge" style="margin-bottom: 10px;">G√©ographie</span>
                    <h2>${list.name}</h2>
                    <p style="color: #666;">${list.description || ''}</p>
                </div>
                <div class="items-grid">
                    ${list.items.map(item => `
                        <div class="item-card">
                            <h3>${item.name}</h3>
                            ${item.metadata && Object.keys(item.metadata).length > 0 ? 
                                `<div style="font-size: 0.9em; opacity: 0.9;">${formatMetadata(item.metadata)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- RECHERCHE ---
        function initSearch() {
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    performSearch(query);
                } else {
                    if(appState.listData) viewListDetails(appState.listData);
                }
            });
        }

        async function performSearch(query) {
            try {
                const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                const container = document.getElementById('categories');
                document.getElementById('list-details').style.display = 'none';
                container.style.display = 'grid';
                container.innerHTML = '';

                if (data.results.items.length > 0) {
                     container.innerHTML = data.results.items.map(item => `
                        <div class="item-card">
                            <h3>${item.name}</h3>
                            <p style="font-size: 0.9em;">${item.category_name} > ${item.list_name}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align:center;width:100%">Aucun r√©sultat</div>';
                }
            } catch (e) { console.error(e); }
        }

        // --- START ---
        init();

    </script>
</body>
</html>